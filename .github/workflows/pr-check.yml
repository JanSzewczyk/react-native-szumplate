name: PR Checks âœ…

on:
  pull_request:

env:
  NODE_VERSION: 22.x

jobs:
  prettier:
    name: Prettier ğŸ§¹
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“š
        uses: actions/checkout@v5
      - name: Set up Node ğŸŸ¢
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - name: Install dependencies âš™ï¸
        run: npm ci
      - name: Prettier Check ğŸ§¹
        run: npm run prettier:check

  lint:
    name: ESlint â¬£
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“š
        uses: actions/checkout@v5
      - name: Set up Node ğŸŸ¢
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - name: Install dependencies âš™ï¸
        run: npm ci
      - name: Install utils âš™ï¸
        run: npm install @microsoft/eslint-formatter-sarif
      - name: ESlint Check â¬£
        run: npm run lint:ci
        continue-on-error: true
      - name: Upload ESlint results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: eslint-results.sarif
          wait-for-processing: true

  type-check:
    name: TypeScript ğŸ› ï¸
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“š
        uses: actions/checkout@v5
      - name: Set up Node ğŸŸ¢
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - name: Install dependencies âš™ï¸
        run: npm ci
      - name: TypeScript Check ğŸ› ï¸
        run: npm run type-check

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code ğŸ“š
        uses: actions/checkout@v5
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: on-failure

  bundle-size:
    name: Bundle Size Analysis ğŸ“Š
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code ğŸ“š
        uses: actions/checkout@v5
      - name: Set up Node ğŸŸ¢
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - name: Install dependencies âš™ï¸
        run: npm ci
      - name: Export web build ğŸŒ
        run: npx expo export:web
      - name: Analyze bundle size ğŸ“Š
        uses: andresz1/size-limit-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          build_script: export:web
          skip_step: build

  expo-doctor:
    name: Expo Doctor ğŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“š
        uses: actions/checkout@v5
      - name: Set up Node ğŸŸ¢
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - name: Install dependencies âš™ï¸
        run: npm ci
      - name: Run Expo Doctor ğŸ¥
        run: npx expo-doctor

  duplicate-dependencies:
    name: Duplicate Dependencies Check ğŸ“¦
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“š
        uses: actions/checkout@v5
      - name: Set up Node ğŸŸ¢
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - name: Install dependencies âš™ï¸
        run: npm ci
      - name: Check for duplicate dependencies ğŸ“¦
        run:
          npx jscpd --pattern "package-lock.json" --reporters console || npx npm ls --all --depth=0 | grep -E
          "deduped|extraneous" && exit 1 || echo "No duplicate dependencies found"

  build-validation:
    name: Build Validation ğŸ—ï¸
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [web, android]
    steps:
      - name: Checkout code ğŸ“š
        uses: actions/checkout@v5
      - name: Set up Node ğŸŸ¢
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - name: Set up Java (for Android) â˜•
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
      - name: Install dependencies âš™ï¸
        run: npm ci
      - name: Prebuild ${{ matrix.platform }} ğŸ—ï¸
        if: matrix.platform == 'android'
        run: npx expo prebuild --platform android --clean
      - name: Build web ğŸŒ
        if: matrix.platform == 'web'
        run: npx expo export:web
      - name: Check Android build files
        if: matrix.platform == 'android'
        run: |
          if [ ! -d "android" ]; then
            echo "Android directory not generated"
            exit 1
          fi
          echo "Android prebuild successful"

  license-compliance:
    name: License Compliance âš–ï¸
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code ğŸ“š
        uses: actions/checkout@v5
      - name: Set up Node ğŸŸ¢
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - name: Install dependencies âš™ï¸
        run: npm ci
      - name: Check licenses âš–ï¸
        run: |
          npx license-checker --summary --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;CC0-1.0;Unlicense;Python-2.0" || echo "âš ï¸ Some dependencies have licenses that need review"
